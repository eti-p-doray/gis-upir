<!DOCTYPE html>
<html>
<head>
<title>Hello</title>
<link rel="stylesheet" src="css/ol.css">
<script src="resources/ol.js" type="text/javascript"></script>
<script src="resources/proj4.js" type="text/javascript"></script>
<script src="resources/papaparse.js" type="text/javascript"></script>
<script src="resources/shp.min.js" type="text/javascript"></script>
<script src="resources/jquery-3.1.1.js" type="text/javascript"></script>
<script>

"use strict";

proj4.defs('EPSG:2150', 'PROJCS["NAD83(CSRS98) / MTM zone 8 (deprecated)",GEOGCS["NAD83(CSRS98)",DATUM["D_North_American_1983_CSRS98",SPHEROID["GRS_1980",6378137,298.257222101]],PRIMEM["Greenwich",0],UNIT["Degree",0.017453292519943295]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",-73.5],PARAMETER["scale_factor",0.9999],PARAMETER["false_easting",304800],PARAMETER["false_northing",0],UNIT["Meter",1]]');

function rainbowColor(length, maxLength) {
  var i = (length * 255 / maxLength);
  var r = Math.round(Math.sin(0.024 * i + 0) * 127 + 128);
  var g = Math.round(Math.sin(0.024 * i + 2) * 127 + 128);
  var b = Math.round(Math.sin(0.024 * i + 4) * 127 + 128);
  return 'rgb(' + r + ',' + g + ',' + b + ')';
}

var strokes = {
  road: new ol.style.Stroke({
    color: 'blue', width: 1.0
  }),
  cycling: new ol.style.Stroke({
    color: 'green', width: 1.0
  }),
  highlighted: new ol.style.Stroke({
    color: 'LightSkyBlue', width: 2.0
  }),
  selected: new ol.style.Stroke({
    color: 'LightSkyBlue', width: 2.0
  }),
  raw_trajectory: new ol.style.Stroke({
    color: 'DarkGoldenRod', width: 1.0
  }),
  smoothed_trajectory: new ol.style.Stroke({
    color: 'red', width: 1.0
  }),
  mm_trajectory: new ol.style.Stroke({
    color: 'yellow', width: 4.0
  })
};
var styles = {
  road: new ol.style.Style({stroke: strokes.road}),
  cycling: new ol.style.Style({stroke: strokes.cycling}),
  highlighted: new ol.style.Style({stroke: strokes.highlighted}),
  selected: new ol.style.Style({stroke: strokes.selected}),
  filtered: new ol.style.Style({stroke: strokes.highlighted}),

  raw_trajectory: new ol.style.Style({stroke: strokes.raw_trajectory}),
  smoothed_trajectory: new ol.style.Style({stroke: strokes.smoothed_trajectory}),
  mm_trajectory: new ol.style.Style({stroke: strokes.mm_trajectory}),
};

function clusterStyle(feature) {
  return new ol.style.Style({
    image: new ol.style.Circle({
      radius: 5,
      fill: new ol.style.Stroke({
        color: rainbowColor(feature.getProperties().label, 150)
      })
    })
  })
}

function Map() {
  this.map = new ol.Map({
    target: 'map',
    layers: [
      new ol.layer.Tile({
        source: new ol.source.OSM()
      })
    ],
    view: new ol.View({
      center: [-73, 45],
      zoom: 9,
      projection: 'EPSG:4326'
    })
  });
}

Map.prototype.removeInteraction = function(interaction) {
  this.map.removeInteraction(interaction);
}

Map.prototype.addSelectInteraction = 
    function(options, onSelect, onDeselect) {
  let select = new ol.interaction.Select(options);
  select.on('select', function(e) {
    e.deselected.forEach(function(feature) {
      let layer = feature.layer;
      if (layer.name in onDeselect) {
        var handler = onDeselect[layer.name];
        handler(feature, layer);
      }
    });
    e.selected.forEach(function(feature) {
      let layer = select.getLayer(feature);
      feature.layer = layer;
      if (layer.name in onSelect) {
        var handler = onSelect[layer.name];
        handler(feature, layer);
      }
    });
  });
  this.map.addInteraction(select);
  return select;
}

Map.prototype.setStyle = function(layer, features, style) {
  $.each(features, function(_, i) {
    let idx = layer.index[i];
    layer.getSource().getFeatures()[idx].setStyle(style);
  });
}

Map.prototype.removeStyle = function(layer, features) {
  $.each(features, function(_, i) {
    let idx = layer.index[i];
    layer.getSource().getFeatures()[idx].setStyle();
  });
}

Map.prototype.addLayer = function(vector, style, name) {
  var vectorLayer = new ol.layer.Vector({
    source: vector, style: style
  });
  vectorLayer.name = name;
  vectorLayer.index = {};
  vector.getFeatures().forEach(
    function(d,i){ vectorLayer.index[d.getProperties().id] = i; });
  this.map.addLayer(vectorLayer);
  return vectorLayer;
}

Map.prototype.addShp = function(name, style) {
  var deferred = new $.Deferred();
  shp(name).then(function(geojson){
    var vectorSource = new ol.source.Vector({
      features: (new ol.format.GeoJSON()).readFeatures(geojson)
    });
    var vl = this.addLayer(vectorSource, style, name);
    deferred.resolve(vl);
  }.bind(this));
  return deferred.promise();
}

Map.prototype.addGeojson = function(request, style, name) {
  name = name || request;
  var deferred = new $.Deferred();
  $.ajax(request).then(function(geojson){
    var vectorSource = new ol.source.Vector({
      features: (new ol.format.GeoJSON()).readFeatures(geojson, {featureProjection: 'EPSG:4326'})
    });
    var vl = this.addLayer(vectorSource, style, name);
    deferred.resolve(vl);
  }.bind(this));
  return deferred.promise();
}

function Controller() {
  this.fileInput = document.querySelector('#fileInput');
}

Controller.prototype.updateCluster = function(trajectoryLayer, clusterLayer, interaction) {
  $.ajax({
    url: '/cluster/selection', type: 'get',
    data: $.param({labels : [...this.selection]}),
    dataType: "json",
    success: function(features){
      let exit = $(this.highlighted).not(features);
      let enter = $(features).not(this.highlighted);
      this.highlighted = features;
      this.map.removeStyle(trajectoryLayer, exit);
      this.map.setStyle(trajectoryLayer, enter, styles.highlighted);
    }.bind(this)
  });
}

Controller.prototype.addSelectInteractions = 
    function(trajectoryLayer, clusterLayer) {
  let onSelect = {};
  let onDeselect = {};

  onSelect[clusterLayer.name] = function(feature, layer, interaction) {
    let properties = feature.getProperties();
    this.selection.add(properties.label);
    this.updateCluster(trajectoryLayer, layer, interaction);
  }.bind(this);
  onDeselect[clusterLayer.name] = function(feature, layer, interaction) {
    let properties = feature.getProperties();
    this.selection.delete(properties.label);
    this.updateCluster(trajectoryLayer, layer, interaction);
  }.bind(this);

  onSelect[trajectoryLayer.name] = function(feature, layer, interaction) {
    let properties = feature.getProperties();
    console.log(properties);
  }.bind(this);

  this.map.addSelectInteraction({

  }, onSelect, onDeselect);
}

Controller.prototype.bind = function() {
  this.map = new Map();
  this.selection = new Set([]);
  this.highlighted = [];

  let trajectoriesPromise = 
    this.map.addGeojson("http://localhost:8000/data/bike_path/smoothed.json",
    function(feature) { return styles.smoothed_trajectory; });

  let clusterPromise = this.map.addGeojson("cluster/center.json", clusterStyle);

  $.when(trajectoriesPromise, clusterPromise).then(this.addSelectInteractions.bind(this));

  this.map.addGeojson("http://localhost:8000/data/osm/jean-drapeau.json");
  this.map.addGeojson("http://localhost:8000/data/bike_path/mm.json", 
    function(feature) { return styles.mm_trajectory; });


};

document.addEventListener('DOMContentLoaded', function() {
  var contr = new Controller();
  contr.bind();
});

</script>
</head>

<body>
  <div>
    <div id="map" style="width: 100%, height: 100%"></div>
  </div>
</body>
</html>